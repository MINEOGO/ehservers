<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emergency Hamburg Servers</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: #fff;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    .server-card {
      background: #1e1e1e;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
    }
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #333;
    }
    .social-links a {
      margin-right: 10px;
      color: #00bfff;
      text-decoration: none;
    }
    .social-links a:hover {
      text-decoration: underline;
    }
    h1 {
      margin-bottom: 30px;
      text-align: center;
      color: #00bfff;
    }
    .log-output {
      background: #222;
      border: 1px solid #333;
      padding: 10px;
      margin-top: 20px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }
    .error { color: #ff6b6b; }
    .warning { color: #ffa500; }
    .success { color: #76ff03; }
    .info { color: #ccc; }
    .status-message { text-align: center; padding: 20px; font-size: 1.1em;}
  </style>
</head>
<body>
  <h1>Emergency Hamburg Servers</h1>
  <div id="servers-container">
    <p class="status-message info">Loading servers...</p>
  </div>
  <div id="log-container" class="log-output" style="display: none;">
    <h3>Developer Logs:</h3>
    <div id="logs"></div>
  </div>

  <script>
    // --- Configuration ---
    const API_ENDPOINT = "https://185.58.157.203:7677/servers"; // HTTPS endpoint with your IP and new port
    const FETCH_TIMEOUT_MS = 10000; // 10 seconds timeout for the API request

    // --- DOM Elements ---
    const serversDiv = document.getElementById("servers-container");
    const logContainerDiv = document.getElementById("log-container");
    const logsDiv = document.getElementById("logs");

    // --- Logging Function ---
    function logMessage(message, type = "info") {
      console.log(`[${type.toUpperCase()}] ${message}`);
      logContainerDiv.style.display = "block";
      const p = document.createElement("p");
      p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      p.classList.add(type);
      logsDiv.appendChild(p);
      // Scroll to bottom of logs
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    // --- Main Function to Load Servers ---
    async function loadServers() {
      serversDiv.innerHTML = `<p class="status-message info">Attempting to connect to server list at ${API_ENDPOINT}...</p>`;
      logMessage(`Fetching servers from: ${API_ENDPOINT}`, "info");

      const controller = new AbortController();
      const timeoutId = setTimeout(() => {
        controller.abort();
        logMessage(`Fetch request to ${API_ENDPOINT} timed out after ${FETCH_TIMEOUT_MS / 1000} seconds.`, "error");
      }, FETCH_TIMEOUT_MS);

      try {
        const response = await fetch(API_ENDPOINT, { signal: controller.signal });
        clearTimeout(timeoutId); // Clear timeout if fetch completes

        logMessage(`Received response. Status: ${response.status} ${response.statusText}`, response.ok ? "info" : "warning");

        const responseTextForLogging = await response.text(); // Get raw text for logging
        logMessage(`Raw API Response (first 500 chars):\n${responseTextForLogging.substring(0, 500)}${responseTextForLogging.length > 500 ? '...' : ''}`, "info");


        if (!response.ok) {
          serversDiv.innerHTML = `<p class="status-message error">Error fetching servers: ${response.status} ${response.statusText}. Check logs for more details.</p>`;
          logMessage(`API Error: ${response.status} ${response.statusText}. The server responded with an error.`, "error");
          return;
        }

        let data;
        try {
          data = JSON.parse(responseTextForLogging); // Parse the text we already fetched
          logMessage("Successfully parsed JSON response.", "success");
        } catch (jsonError) {
          serversDiv.innerHTML = `<p class="status-message error">Failed to parse JSON response from API. The server's response was not valid JSON.</p>`;
          logMessage(`JSON Parsing Error: ${jsonError.message}. Raw response started with: ${responseTextForLogging.substring(0,100)}`, "error");
          console.error("JSON Parsing Error:", jsonError);
          return;
        }
        
        if (!Array.isArray(data)) {
          serversDiv.innerHTML = "<p class='status-message warning'>No valid server data: API did not return an array.</p>";
          logMessage("API data is not an array. Received:", "warning");
          console.warn("API Data (not an array):", data);
          return;
        }

        if (data.length === 0) {
          serversDiv.innerHTML = "<p class='status-message info'>No servers are currently listed.</p>";
          logMessage("API returned an empty list of servers.", "info");
          return;
        }
        
        serversDiv.innerHTML = ""; // Clear loading/error messages
        logMessage(`Found ${data.length} servers. Rendering cards...`, "success");

        data.forEach(server => {
          const card = document.createElement("div");
          card.className = "server-card";

          const serverName = server.serverName || "Unnamed Server";
          const serverDescription = (server.serverDescription || "No description available.").replace(/\r\n/g, "<br>");
          const ownerName = server.ownerName || "Unknown Owner";
          const ownerProfileUrl = server.ownerProfileUrl || "https://via.placeholder.com/60/333333/FFFFFF/?text=N/A";
          const currentPlayers = server.currentPlayers !== undefined ? server.currentPlayers : "?";
          const maxPlayers = server.maxPlayers !== undefined ? server.maxPlayers : "?";

          let socialLinksHTML = "";
          if (server.socialLinks) {
            if (server.socialLinks.Discord) {
              socialLinksHTML += ` <a href="https://discord.gg/${server.socialLinks.Discord}" target="_blank" rel="noopener noreferrer">Discord</a>`;
            }
            if (server.socialLinks.YouTube) {
              let ytLink = server.socialLinks.YouTube;
              if (ytLink && !ytLink.startsWith('http://') && !ytLink.startsWith('https://')) {
                ytLink = 'https://' + ytLink;
              }
              if(ytLink) socialLinksHTML += ` <a href="${ytLink}" target="_blank" rel="noopener noreferrer">YouTube</a>`;
            }
            if (server.socialLinks.X) {
              let xHandle = server.socialLinks.X.replace(/^@/, '');
              if(xHandle) socialLinksHTML += ` <a href="https://x.com/${xHandle}" target="_blank" rel="noopener noreferrer">X (Twitter)</a>`;
            }
          }
          socialLinksHTML = socialLinksHTML.trim();

          card.innerHTML = `
            <h3>${serverName}</h3>
            <p>${serverDescription}</p>
            <hr style="border-color: #333; margin: 10px 0;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
              <img src="${ownerProfileUrl}" class="avatar" alt="${ownerName} Avatar" 
                   onerror="this.onerror=null; this.src='https://via.placeholder.com/60/333333/FFFFFF/?text=Err'; this.alt='Image load error';"/>
              <p style="margin-left: 15px;"><strong>Owner:</strong> ${ownerName}</p>
            </div>
            <p><strong>Players:</strong> ${currentPlayers} / ${maxPlayers}</p>
            <div class="social-links">
              ${socialLinksHTML ? socialLinksHTML : '<em>No social links provided.</em>'}
            </div>
          `;
          serversDiv.appendChild(card);
        });
        logMessage("Successfully rendered all server cards.", "success");

      } catch (error) {
        clearTimeout(timeoutId);
        console.error("Error in loadServers function:", error);
        serversDiv.innerHTML = `<p class="status-message error">Could not load servers. An unexpected error occurred.</p>`;
        
        if (error.name === 'AbortError') {
          serversDiv.innerHTML += `<p class="status-message error">The request to the server timed out.</p>`;
          logMessage(`Fetch aborted (likely timeout): ${error.message}`, "error");
        } else if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
          // THIS IS THE KEY ERROR FOR SELF-SIGNED CERT ISSUES (before accepting the cert)
          // OR IF THE SERVER IS COMPLETELY UNREACHABLE
          serversDiv.innerHTML += `<p class="status-message error"><strong>Connection Error:</strong> Unable to connect to the server at ${API_ENDPOINT}.<br>
          Possible reasons:
          <ul style="text-align: left; display: inline-block;">
            <li>The backend server is not running or is unreachable.</li>
            <li>Firewall might be blocking the connection.</li>
            <li><strong>If using a self-signed SSL certificate:</strong> You may need to visit <a href="${API_ENDPOINT}" target="_blank" rel="noopener noreferrer">${API_ENDPOINT}</a> directly in your browser and accept the security warning.</li>
          </ul>
          Check the browser console (F12) for more specific error messages (e.g., NET::ERR_CERT_AUTHORITY_INVALID).</p>`;
          logMessage(`"Failed to fetch" error: ${error.message}. This often indicates a network issue, firewall, or an unaccepted self-signed SSL certificate.`, "error");
        } else {
          serversDiv.innerHTML += `<p class="status-message error">Details: ${error.message}. Check browser console.</p>`;
          logMessage(`An unexpected JavaScript error occurred: ${error.message}`, "error");
        }
      }
    }

    // Initial call to load servers
    loadServers();
  </script>
</body>
</html>
